<script lang="ts">
	import anime from 'animejs/lib/anime.es.js';
	import { onMount } from 'svelte';

	const PAPER_SIDE_STEPS = [
		'M544.574 212.216C521.58 255.992 423.856 248.475 413.686 208.236V299.327C422.972 344.43 529.097 345.757 545.458 302.422L540.594 294.905L544.132 282.524L538.383 270.142L544.132 255.992L538.383 243.169L544.574 212.216Z',
		'M551.208 268.374C493.722 241.4 422.53 246.706 413.686 204.698V299.769C424.741 345.315 492.395 328.511 548.111 355.485L537.499 336.913L548.111 326.3L537.499 309.939L548.111 299.769L537.499 282.966L551.208 268.374Z',
		'M560.147 238.869C476.919 257.319 422.972 235.331 413.686 204.698V299.769C422.53 342.219 511.852 351.675 558.282 329.521L547.729 312.846L558.282 301.266L549.496 286.946L560.147 272.339L547.729 260.456L560.147 238.869Z'
	];

	let svgEl: SVGElement;
	let textEl: SVGPathElement;
	let paperHoleEl: SVGCircleElement;
	let paperTopEl: SVGGElement;
	let paperBodyEl: SVGRectElement;
	let paperSideEl: SVGPathElement;
	let subtitleEl: HTMLParagraphElement;

	let isIntroAnimationFinished = false;

	onMount(async () => {
		await anime
			.timeline({
				duration: 1000,
				easing: 'easeInOutSine'
			})
			.add({
				targets: svgEl,
				opacity: 1
			})
			// text draw
			.add({
				targets: textEl,
				strokeDashoffset: [anime.setDashoffset, 0],
				duration: 2000
			})
			.add(
				{
					targets: textEl,
					fill: ['#000000', '#ffffff'],
					duration: 800
				},
				1500
			)
			// Push up
			.add(
				{
					targets: paperBodyEl,
					y: [296.56, 203.7],
					height: [0, 92.86],
					easing: 'easeOutElastic'
				},
				2000
			)
			.add(
				{
					targets: paperHoleEl,
					fill: ['#000000', '#bdbdbd'],
					duration: 200
				},
				2000
			)
			.add(
				{
					targets: paperTopEl,
					translateY: [92.86, 0],
					easing: 'easeOutElastic'
				},
				2000
			)
			// Show subtitle
			.add(
				{
					targets: subtitleEl,
					opacity: [0, 1]
				},
				'-=500'
			)
			// Peel
			.add(
				{
					targets: paperSideEl,
					fill: ['none', '#f2f2f2'],
					duration: 1
				},
				'-=500'
			)
			.add({
				targets: paperBodyEl,
				fill: ['#f2f2f2', '#bdbdbd'],
				duration: 200
			})
			.add(
				{
					targets: paperSideEl,
					d: PAPER_SIDE_STEPS[1]
				},
				'-=200'
			).finished;

		isIntroAnimationFinished = true;

		anime({
			targets: paperSideEl,
			d: PAPER_SIDE_STEPS.slice(1),
			direction: 'alternate',
			loop: true
		});
	});
</script>

<div
	class="flex justify-center items-center transition-height ease-in-out duration-1500 py-12 md:py-24 {isIntroAnimationFinished
		? 'min-h-[360px] md:min-h-[520px]'
		: 'min-h-screen'}"
>
	<div class="flex flex-col w-full max-w-2xl space-y-8">
		<svg
			class="opacity-0 w-full h-full"
			bind:this={svgEl}
			viewBox="0 0 703 480"
			fill="none"
			xmlns="http://www.w3.org/2000/svg"
		>
			<g clip-path="url(#clip0_301_2)">
				<path
					bind:this={textEl}
					d="M132.439 371.859C122.317 377.703 110.946 381.74 98.3274 383.97C85.8039 386.145 73.2272 386.372 60.5972 384.651C47.9669 382.821 36.5266 378.985 26.2763 373.143C16.0259 367.301 9.26464 360.764 5.99251 353.531C2.81586 346.243 3.08257 339 6.79263 331.802C10.5982 324.549 17.562 318.001 27.6841 312.157C37.7107 306.368 48.9857 302.386 61.5092 300.211C74.1281 297.981 86.7527 297.782 99.383 299.612C112.013 301.442 123.454 305.278 133.704 311.12C143.954 316.962 150.716 323.499 153.988 330.732C157.164 337.911 156.849 345.127 153.044 352.379C149.334 359.577 142.466 366.07 132.439 371.859ZM108.585 358.264C113.646 355.342 117.128 352.013 119.031 348.277C120.933 344.541 120.97 340.728 119.142 336.838C117.314 332.947 113.526 329.364 107.778 326.088C102.03 322.812 95.8074 320.69 89.1095 319.721C82.4113 318.643 75.8118 318.661 69.3111 319.776C62.7145 320.837 56.838 322.856 51.6814 325.833C46.4294 328.866 42.9001 332.277 41.0934 336.068C39.1909 339.804 39.1537 343.617 40.9819 347.508C42.8097 351.288 46.5975 354.816 52.3454 358.092C58.0932 361.368 64.3163 363.545 71.0144 364.624C77.8081 365.647 84.4553 365.601 90.9561 364.486C97.5524 363.315 103.429 361.242 108.585 358.264ZM124.878 294.619L149.229 280.56L157.85 285.474C157.459 282.183 158.883 278.668 162.125 274.928C165.271 271.133 169.804 267.527 175.724 264.109L195.123 275.165C188.821 278.804 184.145 282.547 181.095 286.397C178.14 290.191 177.576 293.649 179.402 296.771L219.062 319.374L193.853 333.929L124.878 294.619ZM287.999 282.047C280.837 286.182 273.002 289.002 264.494 290.507C255.89 291.957 247.329 292.009 238.813 290.661C230.201 289.258 222.255 286.482 214.974 282.333C207.79 278.238 202.947 273.725 200.446 268.794C197.85 263.809 197.741 258.871 200.118 253.982C202.591 249.037 207.456 244.47 214.713 240.28C219.488 237.523 224.551 235.369 229.903 233.818C235.255 232.267 240.608 231.374 245.964 231.139L203.142 206.734L228.352 192.179L334.544 252.701L310.194 266.76L303.296 262.829C302.933 269.962 297.834 276.368 287.999 282.047ZM275.045 267.105C278.865 264.899 281.344 262.369 282.484 259.513C283.528 256.602 283.042 253.805 281.026 251.122L268.812 244.161C264.122 243.022 259.291 242.789 254.319 243.461C249.252 244.078 244.808 245.49 240.989 247.695C235.832 250.672 233.211 253.944 233.125 257.511C233.04 261.077 235.631 264.362 240.9 267.365C246.169 270.368 251.912 271.833 258.129 271.761C264.25 271.634 269.888 270.082 275.045 267.105ZM282.734 192.93C278.914 195.135 274.47 196.272 269.401 196.341C264.332 196.41 259.882 195.353 256.05 193.169C252.314 191.039 250.489 188.521 250.577 185.613C250.569 182.65 252.474 180.066 256.294 177.861C260.018 175.711 264.463 174.628 269.627 174.614C274.792 174.49 279.242 175.492 282.978 177.622C286.714 179.751 288.539 182.324 288.452 185.342C288.364 188.25 286.458 190.779 282.734 192.93ZM279.326 205.448L304.536 190.894L373.51 230.204L348.3 244.759L279.326 205.448ZM318.332 182.928L342.682 168.869L350.298 173.21C350.001 169.645 351.14 166.185 353.713 162.831C356.286 159.477 359.864 156.477 364.448 153.83C374.092 148.262 383.745 145.602 393.406 145.849C403.066 145.987 412.208 148.512 420.829 153.426L463.938 177.995L438.729 192.55L398.925 169.865C391.165 165.442 383.752 165.271 376.686 169.351C373.439 171.225 371.245 173.371 370.104 175.788C368.867 178.151 368.875 180.73 370.126 183.524L412.516 207.684L387.307 222.239L318.332 182.928ZM502.113 158.428C493.519 163.39 484.489 166.24 475.022 166.98C465.555 167.61 457.085 165.796 449.613 161.537C441.853 157.115 438.444 152.268 439.386 146.999C440.327 141.619 445.573 136.173 455.122 130.66C458.846 128.51 463.001 126.605 467.588 124.947C472.078 123.233 476.331 121.987 480.346 121.207L478.909 120.389C471.532 116.184 461.828 117.556 449.796 124.502C441.393 129.354 435.335 134.72 431.621 140.601L414.234 130.692C415.852 128.109 418.713 125.138 422.817 121.78C426.824 118.367 431.502 115.117 436.849 112.029C449.645 104.642 461.876 100.547 473.543 99.7467C485.209 98.8363 495.64 101.002 504.837 106.243L546.796 130.157L523.162 143.802L517.271 140.444C517.183 143.352 515.9 146.346 513.422 149.426C510.944 152.505 507.174 155.506 502.113 158.428ZM494.042 145.283C497.003 143.573 499.197 141.647 500.626 139.503C501.959 137.305 502.336 135.274 501.757 133.41L495.721 129.97C488.837 130.758 482.769 132.668 477.517 135.7C474.175 137.629 472.315 139.527 471.938 141.394C471.56 143.26 472.761 144.985 475.539 146.569C478.125 148.043 480.996 148.693 484.152 148.52C487.404 148.291 490.7 147.212 494.042 145.283ZM489.965 83.836L514.315 69.7774L522.937 74.6912C522.545 71.4003 523.97 67.885 527.211 64.1451C530.357 60.3506 534.89 56.7443 540.811 53.3261L560.21 64.3821C553.907 68.0208 549.231 71.7647 546.181 75.6138C543.227 79.4078 542.663 82.8659 544.489 85.9881L584.149 108.592L558.939 123.146L489.965 83.836ZM665.521 94.2535C662.465 96.0177 659.027 97.7281 655.206 99.3847C651.48 101.096 648.423 102.202 646.033 102.702L627.209 91.9738C631.128 91.0302 634.854 89.5384 638.387 87.4985C641.538 85.6792 643.255 83.8638 643.536 82.0525C644.01 80.2406 643.287 78.1852 641.367 75.8862L638.488 72.2731L544.031 52.6208L569.241 38.066L631.979 53.2805L604.047 17.9704L629.257 3.41554L673.032 60.9018C678.311 67.7453 680.385 73.8569 679.252 79.2369C678.215 84.5617 673.638 89.5672 665.521 94.2535ZM284.402 465.534C269.314 474.244 253.928 478.512 238.241 478.336C222.459 478.106 207.91 474.196 194.594 466.607L136.253 433.357L161.606 418.72L220.235 452.134C226.94 455.955 233.784 457.829 240.766 457.755C247.844 457.625 254.533 455.741 260.836 452.103C267.138 448.464 270.332 444.642 270.416 440.636C270.501 436.631 267.19 432.717 260.484 428.896L201.856 395.482L227.209 380.844L285.55 414.094C298.961 421.738 305.871 430.058 306.279 439.055C306.782 447.996 299.49 456.823 284.402 465.534ZM270.831 391.763L295.181 377.704L302.797 382.045C302.5 378.48 303.639 375.02 306.212 371.666C308.785 368.312 312.363 365.312 316.947 362.665C326.591 357.097 336.244 354.437 345.905 354.684C355.565 354.822 364.707 357.347 373.328 362.261L416.437 386.83L391.228 401.385L351.424 378.7C343.664 374.277 336.251 374.106 329.185 378.186C325.938 380.06 323.744 382.206 322.603 384.623C321.366 386.986 321.374 389.565 322.625 392.359L365.015 416.519L339.806 431.073L270.831 391.763ZM381.053 348.239L371.456 353.78L353.925 343.789L363.522 338.248L354.9 333.334C345.608 328.038 341.336 322.262 342.083 316.005C342.831 309.639 347.884 303.754 357.242 298.351C362.494 295.319 367.94 293.164 373.579 291.886L393.697 303.352C389.682 304.131 386.003 305.485 382.661 307.415C378.841 309.62 376.886 311.738 376.796 313.768C376.706 315.799 378.53 317.878 382.266 320.008L388.732 323.693L404.631 314.514L422.162 324.505L406.263 333.684L457.706 363.003L432.497 377.558L381.053 348.239ZM473.368 232.13L498.578 217.575L604.769 278.097L579.56 292.651L473.368 232.13ZM653.423 252.479C646.261 256.614 638.426 259.434 629.918 260.939C621.314 262.39 612.754 262.441 604.238 261.093C595.626 259.691 587.679 256.915 580.399 252.765C573.214 248.671 568.371 244.158 565.871 239.227C563.274 234.241 563.165 229.304 565.542 224.414C568.015 219.469 572.88 214.902 580.138 210.712C584.912 207.955 589.976 205.801 595.327 204.25C600.679 202.699 606.033 201.806 611.388 201.572L568.567 177.167L593.776 162.612L699.968 223.134L675.618 237.192L668.72 233.261C668.358 240.395 663.259 246.801 653.423 252.479ZM640.469 237.537C644.289 235.332 646.769 232.801 647.908 229.945C648.952 227.034 648.466 224.237 646.45 221.555L634.236 214.593C629.546 213.454 624.715 213.221 619.744 213.893C614.676 214.511 610.233 215.922 606.413 218.128C601.257 221.105 598.635 224.377 598.55 227.943C598.464 231.51 601.056 234.794 606.325 237.797C611.593 240.8 617.336 242.265 623.553 242.193C629.674 242.066 635.313 240.514 640.469 237.537Z"
					fill="#ffffff"
					stroke="white"
					stroke-width="-1"
				/>
				<g id="paper" filter="url(#filter0_d_301_2)">
					<circle
						cx="53.9"
						cy="53.9"
						r="53.9"
						transform="matrix(0.866025 -0.5 0.872837 0.488012 386.27 296.991)"
						fill="#f2f2f2"
					/>
					<rect
						bind:this={paperBodyEl}
						x="413.75"
						y="203.7"
						width="132.66"
						height="92.86"
						fill="#f2f2f2"
					/>
					<g bind:this={paperTopEl}>
						<circle
							cx="53.9"
							cy="53.9"
							r="53.9"
							transform="matrix(0.866025 -0.5 0.872837 0.488012 386.27 204.676)"
							fill="white"
						/>
						<circle
							bind:this={paperHoleEl}
							cx="19.6"
							cy="19.6"
							r="19.6"
							transform="matrix(0.866025 -0.5 0.872837 0.488012 446.254 203.984)"
							fill="#bdbdbd"
						/>
					</g>

					<path bind:this={paperSideEl} d={PAPER_SIDE_STEPS[0]} fill="none" />
				</g>
			</g>
			<defs>
				<filter
					id="filter0_d_301_2"
					x="389.686"
					y="146.353"
					width="194.461"
					height="222.754"
					filterUnits="userSpaceOnUse"
					color-interpolation-filters="sRGB"
				>
					<feFlood flood-opacity="0" result="BackgroundImageFix" />
					<feColorMatrix
						in="SourceAlpha"
						type="matrix"
						values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
						result="hardAlpha"
					/>
					<feOffset dy="4" />
					<feGaussianBlur stdDeviation="12" />
					<feComposite in2="hardAlpha" operator="out" />
					<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0" />
					<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_301_2" />
					<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_301_2" result="shape" />
				</filter>
				<clipPath id="clip0_301_2">
					<rect width="775" height="480" fill="white" />
				</clipPath>
			</defs>
		</svg>

		<p bind:this={subtitleEl} class="text-gray-300 font-head text-right md:text-xl opacity-0">
			Bite-size visualization<br />and storytelling experiments.
		</p>
	</div>
</div>
